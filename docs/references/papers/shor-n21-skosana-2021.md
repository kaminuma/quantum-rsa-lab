---
title: "Demonstration of Shor's factoring algorithm for N=21 on IBM quantum processors"
authors: Skosana & Tame
journal: Scientific Reports 11, 16599 (2021)
source: https://www.nature.com/articles/s41598-021-95973-w
arxiv: https://arxiv.org/abs/2103.13855
last_verified: 2026-01-30
---

# N=21 実機実装論文の完全要約

## 概要

5量子ビットのみを使用してN=21を因数分解した世界初の実機デモンストレーション。
**Margolus gate（近似Toffoli）** を使用することで、CXゲート数を大幅に削減し、
当時のノイズの多いIBM量子プロセッサで実行可能にした。

## 重要な数値

| 項目 | 値 |
|------|-----|
| 対象数 | N = 21 = 3 × 7 |
| 使用基数 | a = 4 |
| 量子ビット数 | **5個**（制御3 + 作業2） |
| CXゲート数 | **25個** |
| 回路深度 | **35** |
| 使用プロセッサ | ibmq_casablanca (7量子ビット), ibmq_toronto (27量子ビット) |

## 量子ビット割り当て

```
制御レジスタ: 3量子ビット (c0, c1, c2)
作業レジスタ: 2量子ビット (q0, q1)

状態マッピング (a=4):
  |1⟩  ↦ |00⟩ (q1q0)
  |4⟩  ↦ |01⟩
  |16⟩ ↦ |10⟩
```

**ポイント**: 通常21までの状態を表現するには5量子ビット（0-31）必要だが、
実際に使用する状態は {1, 4, 16} の3つだけなので、2量子ビットで十分。

## 制御ユニタリの実装

### U^1: |1⟩ → |4⟩

```
4^1 mod 21 = 4

回路: 単純なCNOT（状態圧縮により簡略化）
  c ──●──
     │
  q0 ─X──
  q1 ────

※ 2量子ビットで3状態のみエンコードするため可能。
   汎用mod-expは多くのゲートが必要。
```

### U^2: |1⟩ → |16⟩, |4⟩ → |1⟩, |16⟩ → |4⟩

```
4^2 mod 21 = 16

回路: Controlled-SWAP + CNOT
  c ──●────●──
     │    │
  q0 ─X──●─┼──
     │  │ │
  q1 ─X──X─X──
```

### U^4: 循環置換

```
4^4 mod 21 = 256 mod 21 = 4

回路: Margolus + Fredkin
```

## Margolus Gate（近似Toffoli）

標準Toffoliは6 CXゲートだが、Margolus gateは**3 CXゲート**で実装可能。

```
標準Toffoli:
  |a⟩|b⟩|c⟩ → |a⟩|b⟩|c ⊕ (a·b)⟩

Margolus gate:
  同じ動作 + |101⟩状態に-1の位相
```

**なぜ使えるか**: N=21の最適化回路では、作業レジスタが計算基底状態
{|00⟩, |01⟩, |10⟩}のみを取るため、|101⟩（3量子ビットでの表現）の
-1位相は結果に影響しない。制御ビットは重ね合わせ状態だが、
作業レジスタへの影響を考慮した設計になっている。

### Margolus gate回路

```python
def margolus_gate(qc, c1, c2, t):
    qc.ry(π/4, t)
    qc.cx(c1, t)
    qc.ry(π/4, t)
    qc.cx(c2, t)
    qc.ry(-π/4, t)
    qc.cx(c1, t)
    qc.ry(-π/4, t)
```

## 完全な回路構成

```
     ┌───┐                              ┌─────────┐
c0: ─┤ H ├──●──────────────────────────┤         ├─ M
     └───┘  │                          │         │
     ┌───┐  │     ┌─────────────┐      │  QFT†   │
c1: ─┤ H ├──┼─────┤ U² control  ├──────┤         ├─ M
     └───┘  │     └─────────────┘      │         │
     ┌───┐  │                    ┌───┐ │         │
c2: ─┤ H ├──┼────────────────────┤U⁴├─┤         ├─ M
     └───┘  │                    └───┘ └─────────┘
            │
q0: ────────X─────(U² circuit)───(U⁴ circuit)─────

q1: ──────────────(U² circuit)───(U⁴ circuit)─────
```

## 期待される測定結果

```
位相 s/r (r=3):
  s=0: 位相 = 0/3 = 0.000  → 測定値 000
  s=1: 位相 = 1/3 = 0.333  → 測定値 010 or 011
  s=2: 位相 = 2/3 = 0.667  → 測定値 101 or 110
```

周期 r=3 を得られれば因数分解が可能:

**注意**: r=3 は奇数のため、標準的な Shor の手順（gcd(a^(r/2) ± 1, N)）は
直接適用できません。論文では以下の代替アプローチを使用:

```
方法1: 異なる基数 a を試す
  a=2 → r=6（偶数）→ gcd(2³-1, 21)=gcd(7,21)=7 ✓

方法2: 測定結果の統計的解析
  複数回の測定から因数を推定
```

## 実験結果

論文では、ノイズの多い実機でも約40-60%の確率で正しい位相を測定できた。
エンタングルメントの存在も確認され、量子優位性の必要条件を満たした。

## 実装コード（このリポジトリ）

```python
from quantum_crypto.modexp.n21_optimized import build_full_circuit_n21

qc = build_full_circuit_n21()
# 5量子ビット、深度35の最適化回路
```

## 参考リンク

- [Nature論文](https://www.nature.com/articles/s41598-021-95973-w)
- [arXiv版](https://arxiv.org/abs/2103.13855)
- [PMC全文](https://pmc.ncbi.nlm.nih.gov/articles/PMC8368060/)
